<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Eclipse Quest</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f1f1f1;
        }
        #titleScreen, #gameMap, #endScreen, #levelCompleteScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            color: white;
            font-family: Arial, sans-serif;
        }
        #startButton, .levelButton, #retryButton, #menuButton, #retryLevelButton, #mainMenuButton {
            padding: 10px 20px;
            font-size: 20px;
            margin-top: 20px;
            cursor: pointer;
        }
        .levelButton, #retryButton, #menuButton, #retryLevelButton, #mainMenuButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        #topLeftButtons {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        .button {
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="titleScreen">
        <h1>Eclipse Quest</h1>
        <button id="startButton">Start Game</button>
    </div>
    <div id="gameMap" style="display: none;">
        <h1>Select a Level</h1>
        <button class="levelButton" data-level="1">Level 1</button>
        <button class="levelButton" data-level="2">Level 2</button>
        <button class="levelButton" data-level="3">Level 3</button>
        <button class="levelButton" data-level="4">Level 4</button>
        <button class="levelButton" data-level="5">Level 5</button>
    </div>
    <div id="endScreen" style="display: none;">
        <h1>Game Over</h1>
        <button id="retryButton">Retry</button>
        <button id="menuButton">Main Menu</button>
    </div>
    <div id="levelCompleteScreen" style="display: none;">
        <h1>Level Complete</h1>
        <p id="gemCount"></p>
        <button id="retryLevelButton">Retry Level</button>
        <button id="mainMenuButton">Main Menu</button>
    </div>
    <div id="topLeftButtons" style="display: none;">
        <button id="retryButtonTop" class="button">Retry</button>
        <button id="menuButtonTop" class="button">Main Menu</button>
    </div>

    <audio id="startScreenMusic" src="mixkit-romantic-659.mp3" loop></audio>
    <audio id="level1Music" src="mixkit-beautiful-dream-493.mp3" loop></audio>
    <audio id="level2Music" src="mixkit-pop-05-695.mp3" loop></audio>
    <audio id="level3Music" src="mixkit-praise-the-lord-262.mp3" loop></audio>
    <audio id="level4Music" src="mixkit-villa-penthouse-339.mp3" loop></audio>
    <audio id="levelCompleteMusic" src="mixkit-completion-of-a-level-2063.mp3" loop></audio>

    <script>
        const startScreenMusic = document.getElementById("startScreenMusic");
        const level1Music = document.getElementById("level1Music");
        const level2Music = document.getElementById("level2Music");
        const level3Music = document.getElementById("level3Music");
        const level4Music = document.getElementById("level4Music");
        const levelCompleteMusic = document.getElementById("levelCompleteMusic");

        function playStartScreenMusic() {
            startScreenMusic.play();
        }

        function stopAllMusic() {
            startScreenMusic.pause();
            level1Music.pause();
            level2Music.pause();
            level3Music.pause();
            level4Music.pause();
            levelCompleteMusic.pause();
            startScreenMusic.currentTime = 0;
            level1Music.currentTime = 0;
            level2Music.currentTime = 0;
            level3Music.currentTime = 0;
            level4Music.currentTime = 0;
            levelCompleteMusic.currentTime = 0;
        }

        function playLevelMusic(level) {
            stopAllMusic();
            switch (level) {
                case 1:
                    level1Music.play();
                    break;
                case 2:
                    level2Music.play();
                    break;
                case 3:
                    level3Music.play();
                    break;
                case 4:
                    level4Music.play();
                    break;
            }
        }

         // Update the event listener for the "Start Game" button
    document.getElementById("startButton").addEventListener("click", () => {
        document.getElementById("titleScreen").style.display = "none";
        document.getElementById("gameMap").style.display = "flex";
        playStartScreenMusic(); // Play start screen music
    });

    // Update the event listener for level buttons
    document.querySelectorAll(".levelButton").forEach(button => {
        button.addEventListener("click", () => {
            currentLevel = parseInt(button.getAttribute("data-level"));
            document.getElementById("gameMap").style.display = "none";
            document.getElementById("topLeftButtons").style.display = "flex";
            stopAllMusic(); // Stop the start screen music
            playLevelMusic(currentLevel); // Play the music for the selected level
            createCanvas(currentLevel);
        });
    });

        function playLevelCompleteMusic() {
            stopAllMusic();
            levelCompleteMusic.play();
        }

        function playStartScreenMusic() {
            startScreenMusic.play();
        }

        // Declare arrays for game elements
        const obstacles = [];
        const collectibles = [];
        const doors = [];
        const buttons = [];
        const levers = [];

        const backgroundImageURL = "SunMoon-Background.webp";
        const gameMapBackgroundImageURL = "SunMoon-Background.webp";
        const grassImageURL = "Grass.png";
        const lunaImageURL = "luna.png";
        const solaraImageURL = "solara.png";
        const solaraGrassImageURL = "Solaragrass.png";
        const lunaGrassImageURL = "Lunagrass.png";
        const solaragemImageURL = "Solaragem.png";
        const lunagemImageURL = "Lunagem.jpg";
        const lunaDoorImageURL = "Lunadoor.png";
        const solaraDoorImageURL = "Solaradoor.png";
        const radioactiveGrassImageURL = "Radioactivegrass.png";
        const buttonImageURL = "Button.png";
        const buttonPressedImageURL = "Buttonpress.png";
        const dirtDoorImageURL = "Dirt Door.png";
        const leverUpImageURL = "Leverup.png";
        const leverDownImageURL = "Leverdown.png";
        const boxImageURL = "box.jpg";

        const levelBackgroundImages = {
            1: "creepy cave.jpg",
            2: "creepy cave.jpg",
            3: "creepy cave.jpg",
            4: "creepy cave 2.jpg",
            5: "creepy cave 5.jpg"
        };

let currentLevel = 1;
let lunaGemsCollected = 0;
let solaraGemsCollected = 0;
let lunaReachedDoor = false;
let solaraReachedDoor = false;

const images = {};

function preloadImages() {
    const imageUrls = [
        { name: 'grass', url: grassImageURL },
        { name: 'luna', url: lunaImageURL },
        { name: 'solara', url: solaraImageURL },
        { name: 'solaraGrass', url: solaraGrassImageURL },
        { name: 'lunaGrass', url: lunaGrassImageURL },
        { name: 'solaragem', url: solaragemImageURL },
        { name: 'lunagem', url: lunagemImageURL },
        { name: 'lunaDoor', url: lunaDoorImageURL },
        { name: 'solaraDoor', url: solaraDoorImageURL },
        { name: 'radioactiveGrass', url: radioactiveGrassImageURL },
        { name: 'button', url: buttonImageURL },
        { name: 'buttonPressed', url: buttonPressedImageURL },
        { name: 'dirtDoor', url: dirtDoorImageURL },
        { name: 'leverUp', url: leverUpImageURL },
        { name: 'leverDown', url: leverDownImageURL },
        { name: 'Leverdown', url: 'Leverdown.png' },
        { name: 'Leverup', url: 'Leverup.png' },
        { name: 'box', url: boxImageURL }
    ];

    let loadedImagesCount = 0;
    const totalImages = imageUrls.length;

    return new Promise((resolve, reject) => {
        imageUrls.forEach(imageInfo => {
            const img = new Image();
            img.src = imageInfo.url;
            img.onload = () => {
                images[imageInfo.name] = img;
                loadedImagesCount++;
                if (loadedImagesCount === totalImages) {
                    resolve();
                }
            };
            img.onerror = reject;
        });
    });
}

function createCanvas(level) {
    const canvas = document.createElement("canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    document.body.appendChild(canvas);
    const context = canvas.getContext("2d");

    const tileSize = 100;

    const blueSquare = {
        x: 0,
        y: canvas.height - tileSize,
        size: 50,
        speedX: 0,
        speedY: 0,
        gravity: 0.5,
        jumpPower: -15,
        onGround: true,
        visible: true
    };

    const redSquare = {
        x: 0,
        y: canvas.height - tileSize,
        size: 50,
        speedX: 0,
        speedY: 0,
        gravity: 0.5,
        jumpPower: -15,
        onGround: true,
        visible: true
    };

    const obstacles = [];
    const collectibles = [];
    const doors = [];
    const buttons = [];
    const levers = [];

    function createObstacles(level) {
        obstacles.length = 0;
        collectibles.length = 0;
        doors.length = 0;
        buttons.length = 0;
        levers.length = 0;

        if (level === 1) {
            const rowY = canvas.height - 300;
            const tileSize = 100;

            obstacles.push({ x: 0, y: rowY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: tileSize, y: rowY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: 2 * tileSize, y: rowY, width: tileSize, height: tileSize, type: 'solaraGrass' });
            obstacles.push({ x: 3 * tileSize, y: rowY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: 4 * tileSize, y: rowY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: 5 * tileSize, y: rowY, width: tileSize, height: tileSize, type: 'lunaGrass' });
            obstacles.push({ x: 6 * tileSize, y: rowY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: 7 * tileSize, y: rowY, width: tileSize, height: tileSize, type: 'grass' });

            const startX = canvas.width - 200;
            const startY = canvas.height - 600;

            obstacles.push({ x: startX, y: startY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: startX - tileSize, y: startY, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: startX - 2 * tileSize, y: startY + tileSize, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: startX - 3 * tileSize, y: startY + 2 * tileSize, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: startX - 4 * tileSize, y: startY + 3 * tileSize, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: startX - 5 * tileSize, y: startY + 3 * tileSize, width: tileSize, height: tileSize, type: 'grass' });
            obstacles.push({ x: startX + tileSize, y: startY, width: tileSize, height: tileSize, type: 'grass' });

            for (let i = 0; i < canvas.width / tileSize; i++) {
                const type = (i === Math.floor(canvas.width / tileSize) - 3) ? 'lunaGrass' : 'grass';
                obstacles.push({ x: i * tileSize, y: canvas.height - tileSize, width: tileSize, height: tileSize, type: type });
            }

            collectibles.push({ x: (Math.floor(canvas.width / tileSize) - 2) * tileSize, y: canvas.height - 2 * tileSize, width: tileSize, height: tileSize, type: 'solaragem', collectedBy: 'solara' });
            collectibles.push({ x: 3 * tileSize, y: rowY - tileSize, width: tileSize, height: tileSize, type: 'lunagem', collectedBy: 'luna' });
            doors.push({ x: startX + tileSize, y: startY - tileSize, width: tileSize, height: tileSize, type: 'lunaDoor', character: 'luna', visible: true });
            doors.push({ x: (Math.floor(canvas.width / tileSize)) * tileSize, y: canvas.height - 2 * tileSize, width: tileSize, height: tileSize, type: 'solaraDoor', character: 'solara', visible: true });
        } else if (level === 2) {
            const tileSize = 100;

            for (let i = 0; i < canvas.width / tileSize; i++) {
                const type = (i === Math.floor(canvas.width / tileSize) - 7 || i === Math.floor(canvas.width / tileSize) - 6) ? 'radioactiveGrass' : 'grass';
                obstacles.push({ x: i * tileSize, y: canvas.height - tileSize, width: tileSize, height: tileSize, type: type });
            }

            const startX = canvas.width - tileSize * 4;
            for (let i = 1; i <= 2; i++) {
                obstacles.push({ x: startX + i * tileSize, y: canvas.height - (i + 1) * tileSize, width: tileSize, height: tileSize, type: 'grass' });
            }

            obstacles.push({ x: startX + 3 * tileSize, y: canvas.height - 3 * tileSize, width: tileSize, height: tileSize, type: 'grass' });

            const leftRowY = canvas.height - 3 * tileSize;
            for (let i = 0; i < 3; i++) {
                obstacles.push({ x: i * tileSize, y: leftRowY, width: tileSize, height: tileSize, type: 'grass' });
            }

            const fiveSpacesUpY = canvas.height - 5 * tileSize;
            for (let i = 0; i < 12; i++) {
                obstacles.push({ x: i * tileSize, y: fiveSpacesUpY, width: tileSize, height: tileSize, type: 'grass' });
            }

            const startXNewRow = 11 * tileSize;
            obstacles.push({ x: startXNewRow + tileSize, y: fiveSpacesUpY + tileSize, width: tileSize, height: tileSize, type: 'grass' });

            const buttonX = 4 * tileSize;
            const buttonY = fiveSpacesUpY - tileSize;
            buttons.push({ x: buttonX, y: buttonY, width: tileSize, height: tileSize, type: 'button', state: 'up' });

            const buttonYAbove = fiveSpacesUpY - 3 * tileSize;
            buttons.push({ x: buttonX, y: buttonYAbove, width: tileSize, height: tileSize, type: 'button', state: 'up' });

            const twoSpacesDownY = 1 * tileSize;
            for (let i = 1; i < canvas.width / tileSize; i++) {
                const type = (i === Math.floor(canvas.width / tileSize) - 8 || i === Math.floor(canvas.width / tileSize) - 9) ? 'radioactiveGrass' : 'grass';
                obstacles.push({ x: i * tileSize, y: twoSpacesDownY, width: tileSize, height: tileSize, type: type });
            }

            doors.push({ x: (Math.floor(canvas.width / tileSize) - 1) * tileSize, y: twoSpacesDownY - tileSize, width: tileSize, height: tileSize, type: 'lunaDoor', character: 'luna', visible: true });
            doors.push({ x: (Math.floor(canvas.width / tileSize)) * tileSize, y: twoSpacesDownY - tileSize, width: tileSize, height: tileSize, type: 'solaraDoor', character: 'solara', visible: true });

            collectibles.push({ x: (Math.floor(canvas.width / tileSize) - 1) * tileSize, y: canvas.height - 2 * tileSize, width: tileSize, height: tileSize, type: 'solaragem', collectedBy: 'solara' });
            collectibles.push({ x: tileSize, y: canvas.height - 2 * tileSize, width: tileSize, height: tileSize, type: 'lunagem', collectedBy: 'luna' });
            collectibles.push({ x: (Math.floor(canvas.width / tileSize) - 3) * tileSize, y: twoSpacesDownY - tileSize, width: tileSize, height: tileSize, type: 'lunagem', collectedBy: 'luna' });
            collectibles.push({ x: (Math.floor(canvas.width / tileSize) - 4) * tileSize, y: twoSpacesDownY - tileSize, width: tileSize, height: tileSize, type: 'solaragem', collectedBy: 'solara' });
        } else if (level === 3) {
            const tileSize = 100;

            for (let i = 0; i < canvas.width / tileSize; i++) {
                const type = (i < 2 || i >= Math.floor(canvas.width / tileSize) - 2) ? 'grass' : 'radioactiveGrass';
                obstacles.push({ x: i * tileSize, y: canvas.height - tileSize, width: tileSize, height: tileSize, type: type });
            }

            const leftRowY = canvas.height - 5 * tileSize;
            for (let i = 0; i < 3; i++) {
                obstacles.push({ x: i * tileSize, y: leftRowY, width: tileSize, height: tileSize, type: 'grass' });
            }

            const twoSpacesDownY = 1 * tileSize;
            for (let i = 1; i < canvas.width / tileSize; i++) {
                obstacles.push({ x: i * tileSize, y: twoSpacesDownY, width: tileSize, height: tileSize, type: 'grass' });
            }

            doors.push({ x: tileSize, y: twoSpacesDownY - tileSize, width: tileSize, height: tileSize, type: 'dirtDoor', character: 'dirt', visible: true });
            doors.push({ x: 0, y: canvas.height - 2 * tileSize, width: tileSize, height: tileSize, type: 'solaraDoor', character: 'solara', visible: true });
            doors.push({ x: (Math.floor(canvas.width / tileSize) - 0) * tileSize, y: canvas.height - 2 * tileSize, width: tileSize, height: tileSize, type: 'lunaDoor', character: 'luna', visible: true });

            const firstRowX = 4 * tileSize;
            const firstRowY = canvas.height - 3 * tileSize;
            for (let i = 0; i < 3; i++) {
                obstacles.push({ x: firstRowX + i * tileSize, y: firstRowY, width: tileSize, height: tileSize, type: 'grass' });
            }
            const secondRowX = 9 * tileSize;
            const secondRowY = firstRowY;
            for (let i = 0; i < 3; i++) {
                obstacles.push({ x: secondRowX + i * tileSize, y: secondRowY, width: tileSize, height: tileSize, type: 'grass' });
            }

            const leverX = 3 * tileSize;
            const leverY = twoSpacesDownY - tileSize;
            levers.push({ x: leverX, y: leverY, width: tileSize, height: tileSize, type: 'lever', state: 'up' });

            blueSquare.x = canvas.width - 2 * tileSize;
            blueSquare.y = twoSpacesDownY - tileSize;
            redSquare.x = blueSquare.x + tileSize;
            redSquare.y = blueSquare.y;
        } else if (level === 4) {
        const tileSize = 100;

        const topRowY = 1 * tileSize;
        for (let i = 0; i < 12; i++) {
            obstacles.push({ x: i * tileSize, y: topRowY, width: tileSize, height: tileSize, type: 'grass' });
        }

        const bottomRowY = canvas.height - tileSize;
        for (let i = 0; i < canvas.width / tileSize; i++) {
            obstacles.push({ x: i * tileSize, y: bottomRowY, width: tileSize, height: tileSize, type: 'grass' });
        }

        blueSquare.x = 0;
        blueSquare.y = bottomRowY - blueSquare.size;

        redSquare.x = tileSize;
        redSquare.y = bottomRowY - redSquare.size;

        const upperRowY = bottomRowY - 2 * tileSize;
        for (let i = 0; i < 13; i++) {
            obstacles.push({ x: i * tileSize, y: upperRowY, width: tileSize, height: tileSize, type: 'grass' });
        }

        // Place Luna door one space down from the top of the screen
        doors.push({ x: 0, y: 0, width: tileSize, height: tileSize, type: 'lunaDoor', character: 'luna', visible: true });
        // Place Solara door next to Luna door
        doors.push({ x: tileSize, y: 0, width: tileSize, height: tileSize, type: 'solaraDoor', character: 'solara', visible: true });
        obstacles.push({ x: (canvas.width / tileSize - 1) * tileSize, y: upperRowY, width: tileSize, height: tileSize, type: 'grass' });

        const newObstacleX = canvas.width - 2 * tileSize;
        const newObstacleY = bottomRowY - 5 * tileSize;
        obstacles.push({ x: newObstacleX, y: newObstacleY, width: 2 * tileSize, height: tileSize, type: 'grass' });

        const leverX = canvas.width - 6 * tileSize;
        const leverY = bottomRowY - 7 * tileSize;
        levers.push({ x: leverX, y: leverY, width: tileSize, height: tileSize, type: 'lever', state: 'up' });

        const buttonX = (canvas.width / tileSize - 6) * tileSize;
        const buttonY = bottomRowY - 5 * tileSize;
        buttons.push({ x: buttonX, y: buttonY, width: tileSize, height: tileSize, type: 'button', state: 'up' });

        obstacles.push({ x: 4 * tileSize, y: bottomRowY - 400, width: canvas.width - 8 * tileSize, height: tileSize, type: 'grass' });

        const dirtDoorX = (canvas.width / tileSize - 13) * tileSize;
        const dirtDoorY = bottomRowY - 7 * tileSize;
        doors.push({ x: dirtDoorX, y: dirtDoorY, width: tileSize, height: tileSize, type: 'dirtDoor', character: 'dirt', visible: true });

        const boxX = (canvas.width / tileSize - 12) * tileSize;
        const boxY = bottomRowY - tileSize * 1;
        obstacles.push({ x: boxX, y: boxY, width: tileSize, height: tileSize, type: 'box' }); // Keep box at original size

        // Add Luna gems
        collectibles.push({ x: (canvas.width / tileSize - 1) * tileSize, y: bottomRowY - 3 * tileSize, width: tileSize, height: tileSize, type: 'lunagem', collectedBy: 'luna' });
        collectibles.push({ x: 3 * tileSize, y: bottomRowY - 3 * tileSize, width: tileSize, height: tileSize, type: 'lunagem', collectedBy: 'luna' });

        // Add Solara gems
        collectibles.push({ x: (canvas.width / tileSize - 8) * tileSize, y: bottomRowY - 5 * tileSize, width: tileSize, height: tileSize, type: 'solaragem', collectedBy: 'solara' });
        collectibles.push({ x: newObstacleX + tileSize, y: newObstacleY - tileSize, width: tileSize, height: tileSize, type: 'solaragem', collectedBy: 'solara' });
    }
}

    function endGame(message) {
        document.getElementById("endScreen").style.display = "flex";
        document.getElementById("topLeftButtons").style.display = "none";
        document.body.removeChild(canvas);
        alert(message);
    }

    function levelComplete() {
        document.getElementById("levelCompleteScreen").style.display = "flex";
        document.getElementById("topLeftButtons").style.display = "none";
        document.body.removeChild(canvas);
        document.getElementById("gemCount").innerText = `Luna Gems: ${lunaGemsCollected} | Solara Gems: ${solaraGemsCollected}`;
    }

    function update() {
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.drawImage(levelBackgroundImage, 0, 0, canvas.width, canvas.height);
    obstacles.forEach(obstacle => {
        const image = images[obstacle.type];
        context.drawImage(image, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
    });
    collectibles.forEach(collectible => {
        const image = images[collectible.type];
        context.drawImage(image, collectible.x, collectible.y, collectible.width, collectible.height);
    });
    doors.forEach(door => {
        if (door.visible) {
            const image = images[door.type];
            context.drawImage(image, door.x, door.y, door.width, door.height);
        }
    });
    buttons.forEach(button => {
        const image = button.state === 'down' ? images['buttonPressed'] : images['button'];
        context.drawImage(image, button.x, button.y, button.width, button.height);
    });
    levers.forEach(lever => {
        const image = lever.state === 'down' ? images['leverDown'] : images['leverUp'];
        context.drawImage(image, lever.x, lever.y, lever.width, lever.height);
    });

    function handleCharacter(character) {
        if (character.visible) {
            character.speedY += character.gravity;
            character.x += character.speedX;
            character.y += character.speedY;
            if (character.y + character.size > canvas.height) {
                character.y = canvas.height - character.size;
                character.speedY = 0;
                character.onGround = true;
            }
            obstacles.forEach(obstacle => {
                if (character.x < obstacle.x + obstacle.width &&
                    character.x + character.size > obstacle.x &&
                    character.y + character.size > obstacle.y &&
                    character.y < obstacle.y + obstacle.height) {
                    if (character.speedY > 0) {
                        character.y = obstacle.y - character.size;
                        character.speedY = 0;
                        character.onGround = true;
                    } else if (character.speedY < 0) {
                        character.y = obstacle.y + obstacle.height;
                        character.speedY = 0;
                    }
                    if (obstacle.type === 'solaraGrass' && character === blueSquare) {
                        endGame("Luna hit the SolaraGrass! Game Over.");
                    } else if (obstacle.type === 'lunaGrass' && character === redSquare) {
                        endGame("Solara hit the LunaGrass! Game Over.");
                    } else if (obstacle.type === 'radioactiveGrass') {
                        endGame(`${character === blueSquare ? 'Luna' : 'Solara'} hit the RadioactiveGrass! Game Over.`);
                    } else if (obstacle.type === 'box') {
                        if (character.speedX !== 0) {
                            obstacle.x += character.speedX;
                        }
                    }
                }
            });
            let isOnButton = false;
            buttons.forEach(button => {
                if (character.x < button.x + button.width &&
                    character.x + character.size > button.x &&
                    character.y + character.size > button.y &&
                    character.y < button.y + button.height) {
                    isOnButton = true;
                    button.state = 'down';
                    if (currentLevel === 2) {
                        const leftRowGrass = obstacles.find(obstacle => obstacle.type === 'grass' && obstacle.y === canvas.height - 5 * tileSize);
                        if (leftRowGrass) {
                            leftRowGrass.y -= tileSize; // Move the grass obstacle up
                        }
                    }
                }
            });
            if (!isOnButton) {
                buttons.forEach(button => {
                    button.state = 'up';
                    if (currentLevel === 2) {
                        const leftRowGrass = obstacles.find(obstacle => obstacle.type === 'grass' && obstacle.x === 0 && obstacle.y === canvas.height - 5 * tileSize);
                        if (leftRowGrass) {
                            leftRowGrass.y += tileSize; // Move the leftmost grass obstacle back down
                        }
                    }
                });
            }
            collectibles.forEach((collectible, index) => {
                if (character.x < collectible.x + collectible.width &&
                    character.x + character.size > collectible.x &&
                    character.y + character.size > collectible.y &&
                    character.y < collectible.y + collectible.height &&
                    collectible.collectedBy === (character === blueSquare ? 'luna' : 'solara')) {
                    collectibles.splice(index, 1);
                    if (character === blueSquare) {
                        lunaGemsCollected++;
                    } else {
                        solaraGemsCollected++;
                    }
                }
            });
            doors.forEach(door => {
                if (character.x < door.x + door.width &&
                    character.x + character.size > door.x &&
                    character.y + character.size > door.y &&
                    character.y < door.y + door.height &&
                    door.character === (character === blueSquare ? 'luna' : 'solara')) {
                    character.visible = false;
                    if (character === blueSquare) {
                        lunaReachedDoor = true;
                    } else {
                        solaraReachedDoor = true;
                    }
                }
            });
        }
    }

    handleCharacter(blueSquare);
    handleCharacter(redSquare);

    if (blueSquare.visible) {
        context.drawImage(images.luna, blueSquare.x, blueSquare.y, blueSquare.size, blueSquare.size);
    }
    if (redSquare.visible) {
        context.drawImage(images.solara, redSquare.x, redSquare.y, redSquare.size, redSquare.size);
    }
    if (lunaReachedDoor && solaraReachedDoor) {
        levelComplete();
    }
    requestAnimationFrame(update);
}

    function handleKeyDown(event) {
        switch (event.key) {
            case "a":
                blueSquare.speedX = -5;
                break;
            case "d":
                blueSquare.speedX = 5;
                break;
            case "w":
                if (blueSquare.onGround) {
                    blueSquare.speedY = blueSquare.jumpPower;
                    blueSquare.onGround = false;
                }
                break;
            case "ArrowLeft":
                redSquare.speedX = -5;
                break;
            case "ArrowRight":
                redSquare.speedX = 5;
                break;
            case "ArrowUp":
                if (redSquare.onGround) {
                    redSquare.speedY = redSquare.jumpPower;
                    redSquare.onGround = false;
                }
                break;
            case " ":
                if (currentLevel === 3) {
                    levers.forEach(lever => {
                        if (lever.x < blueSquare.x + blueSquare.size &&
                            lever.x + lever.width > blueSquare.x &&
                            lever.y < blueSquare.y + blueSquare.size &&
                            lever.y + lever.height > blueSquare.y) {
                            lever.state = (lever.state === 'up') ? 'down' : 'up';
                            if (lever.state === 'down') {
                                const dirtDoor = doors.find(door => door.type === 'dirtDoor');
                                if (dirtDoor) {
                                    dirtDoor.visible = false;
                                }
                            }
                        }
                        if (lever.x < redSquare.x + redSquare.size &&
                            lever.x + lever.width > redSquare.x &&
                            lever.y < redSquare.y + redSquare.size &&
                            lever.y + lever.height > redSquare.y) {
                            lever.state = (lever.state === 'up') ? 'down' : 'up';
                            if (lever.state === 'down') {
                                const dirtDoor = doors.find(door => door.type === 'dirtDoor');
                                if (dirtDoor) {
                                    dirtDoor.visible = false;
                                }
                            }
                        }
                    });
                } else if (currentLevel === 4) {
                    levers.forEach(lever => {
                        if (lever.x < blueSquare.x + blueSquare.size &&
                            lever.x + lever.width > blueSquare.x &&
                            lever.y < blueSquare.y + blueSquare.size &&
                            lever.y + lever.height > blueSquare.y) {
                            lever.state = 'down';
                            lever.image = images['Leverdown'];
                            const dirtDoor = doors.find(door => door.type === 'dirtDoor');
                            if (dirtDoor) {
                                dirtDoor.visible = false;
                            }
                        }
                        if (lever.x < redSquare.x + redSquare.size &&
                            lever.x + lever.width > redSquare.x &&
                            lever.y < redSquare.y + redSquare.size &&
                            lever.y + lever.height > redSquare.y) {
                            lever.state = 'down';
                            lever.image = images['Leverdown'];
                            const dirtDoor = doors.find(door => door.type === 'dirtDoor');
                            if (dirtDoor) {
                                dirtDoor.visible = false;
                            }
                        }
                    });
                }
                break;
        }
    }

    function handleKeyUp(event) {
        switch (event.key) {
            case "a":
            case "d":
                blueSquare.speedX = 0;
                break;
            case "ArrowLeft":
            case "ArrowRight":
                redSquare.speedX = 0;
                break;
        }
    }

    window.addEventListener("keydown", handleKeyDown);
    window.addEventListener("keyup", handleKeyUp);

    createObstacles(level);

    const levelBackgroundImage = new Image();
    levelBackgroundImage.src = levelBackgroundImages[level];
    levelBackgroundImage.onload = () => {
        context.drawImage(levelBackgroundImage, 0, 0, canvas.width, canvas.height);
        update();
    };
}

document.getElementById("startButton").addEventListener("click", () => {
    document.getElementById("titleScreen").style.display = "none";
    document.getElementById("gameMap").style.display = "flex";
});

document.querySelectorAll(".levelButton").forEach(button => {
    button.addEventListener("click", () => {
        currentLevel = parseInt(button.getAttribute("data-level"));
        document.getElementById("gameMap").style.display = "none";
        document.getElementById("topLeftButtons").style.display = "flex";
        createCanvas(currentLevel);
    });
});

document.getElementById("retryButton").addEventListener("click", () => {
    document.getElementById("endScreen").style.display = "none";
    document.getElementById("topLeftButtons").style.display = "flex";
    createCanvas(currentLevel);
});

document.getElementById("menuButton").addEventListener("click", () => {
    document.getElementById("endScreen").style.display = "none";
    document.getElementById("gameMap").style.display = "flex";
});

document.getElementById("retryButtonTop").addEventListener("click", () => {
    document.getElementById("topLeftButtons").style.display = "flex";
    createCanvas(currentLevel);
});

document.getElementById("menuButtonTop").addEventListener("click", () => {
    document.getElementById("topLeftButtons").style.display = "none";
    document.getElementById("gameMap").style.display = "flex";
});

document.getElementById("retryLevelButton").addEventListener("click", () => {
    document.getElementById("levelCompleteScreen").style.display = "none";
    document.getElementById("topLeftButtons").style.display = "flex";
    createCanvas(currentLevel);
});

document.getElementById("mainMenuButton").addEventListener("click", () => {
    document.getElementById("levelCompleteScreen").style.display = "none";
    document.getElementById("gameMap").style.display = "flex";
});

document.getElementById("titleScreen").style.backgroundImage = `url(${backgroundImageURL})`;
document.getElementById("gameMap").style.backgroundImage = `url(${gameMapBackgroundImageURL})`;
document.getElementById("endScreen").style.backgroundImage = `url(${backgroundImageURL})`;
document.getElementById("levelCompleteScreen").style.backgroundImage = `url(${backgroundImageURL})`;

preloadImages().then(() => {
    console.log("All images preloaded");
}).catch(error => {
    console.error("Error preloading images:", error);
});
</script>
</body>
</html>
